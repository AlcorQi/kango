import{getStats,getEvents,getConfig,connectSSE,fmtTime,sevPill,safe,toast,state,getAISuggestions}from"./api.js?v=2";
let chart;
let latestIds=new Set();
async function load(){try{const s=await getStats();document.getElementById("metric-total").textContent=String(s.total_anomalies??0);document.getElementById("metric-critical").textContent=String((s.by_severity?.critical)||0);document.getElementById("metric-last").textContent=s.last_detection?fmtTime(s.last_detection):"-";document.getElementById("metric-last-scan").textContent=s.last_scan?fmtTime(s.last_scan):"-";const labels=Object.keys(s.by_type||{});const data=Object.values(s.by_type||{});renderChart(labels,data)}catch(e){toast(e.message||"加载统计失败","error")}
try{const res=await getEvents({page:1,size:10,sort:"detected_at:desc"});renderLatest(res.items||[])}catch(e){toast(e.message||"加载事件失败","error")}}
function renderChart(labels,data){const ctx=document.getElementById("typeChart");if(!ctx)return;const d={labels,datasets:[{label:"类型",data,backgroundColor:["#3a86ff","#ff006e","#fb5607","#8338ec","#3a506b","#06d6a0"]}]};if(chart){chart.data=d;chart.update();return}chart=new Chart(ctx,{type:"pie",data:d,options:{plugins:{legend:{labels:{color:"#e0e6f8"}}}}})}
function renderLatest(items){const tbody=document.getElementById("latest-body");if(!tbody)return;tbody.innerHTML="";items.forEach(it=>{latestIds.add(it.id);const tr=document.createElement("tr");tr.innerHTML=`<td>${fmtTime(it.detected_at)}</td><td>${sevPill(it.severity)}</td><td>${safe(it.type)}</td><td>${safe(it.message)}</td><td>${safe(it.source_file)}:${safe(it.line_number)}</td>`;tbody.appendChild(tr)})}
function onSSEAnomaly(e){if(!e||!e.id)return;const tbody=document.getElementById("latest-body");if(!tbody)return;if(latestIds.has(e.id))return;latestIds.add(e.id);const tr=document.createElement("tr");tr.innerHTML=`<td>${fmtTime(e.detected_at)}</td><td>${sevPill(e.severity)}</td><td>${safe(e.type)}</td><td>${safe(e.message)}</td><td>${safe(e.source_file||"")}</td>`;tbody.prepend(tr);tbody.querySelectorAll("tr").forEach((row,i)=>{if(i>9)row.remove()})}
async function loadAISuggestions(){const wrap=document.getElementById("ai-list");if(!wrap)return;wrap.innerHTML="<div style=\"color:#a7b1c9\">正在加载 AI 建议...</div>";try{const res=await getAISuggestions({limit:1});const items=res?.items||[];if(!items.length){wrap.innerHTML="<div style=\"color:#a7b1c9\">暂无 AI 建议</div>";return}const md=items[0].markdown||items[0].content||"";let html;if(typeof window!=="undefined"&&window.marked){html=window.marked.parse(md);}else{html=`<pre style=\"white-space:pre-wrap\">${safe(md)}</pre>`;}wrap.innerHTML=html;}catch(e){wrap.innerHTML=`<div style="color:#ff6b6b">加载 AI 建议失败：${safe(e.message||"未知错误")}</div>`;}}
document.getElementById("btn-refresh").addEventListener("click",()=>{load();loadAISuggestions()});
const aiBtn=document.getElementById("btn-ai-refresh");if(aiBtn){aiBtn.addEventListener("click",()=>{loadAISuggestions()})}
document.addEventListener("sse:anomaly",ev=>onSSEAnomaly(ev.detail));
connectSSE();
load();
loadAISuggestions();
getConfig().then(c=>{const sec=(c.ui?.auto_refresh_sec)||30;setInterval(()=>{load();loadAISuggestions()},sec*1000)}).catch(()=>{setInterval(()=>{load();loadAISuggestions()},30000)})
