# Linux系统异常检测工具 - 功能架构汇报文档

## 文档目的
- 面向汇报场景，对项目的功能架构进行精炼说明
- 聚焦架构层级、模块职责、数据流与接口，不涉及实现细节
- 关联源文档：`FUNCTIONAL_DESIGN_SINGLE.md`（v1.0 实时 + 分布式 + AI）

## 功能设计总览
- 监控面板：展示今日总数、严重级别统计、最新异常列表、类型分布图表
- 历史查询：按时间范围、严重级别、关键词筛选，分页查看与详情跳转
- 配置管理：检测路径、扫描间隔、数据保留天数、显示与通知配置的读取与更新
- 异常检测：6类异常（OOM/Kernel Panic/异常重启/文件系统/Oops/死锁）规则匹配与事件结构化
- 实时推送：基于SSE的增量事件推送，前端自动刷新与断线重连
- 文件存储：NDJSON按行存储事件，summary.json周期汇总，按日滚动与清理
- 实时检测：journalctl -f/文件尾部监听实现近实时事件捕获
 - 分布式扩展：各主机Agent实时上报，中心Aggregator汇总与推送
 - AI分析与建议：对异常进行解释、原因归纳与缓解建议（人工确认）

## 架构总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        用户界面层（Web界面）                               │
├─────────────────────────────────────────────────────────────────────────┤
│  监控面板（Dashboard） · 历史查询（History） · 配置管理（Settings）        │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         应用服务层（轻量级服务）                            │
├─────────────────────────────────────────────────────────────────────────┤
│  实时监控（SSE） · 数据接口（REST） · 配置服务（REST）                     │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      核心业务层（现有Python引擎增强）                         │
├─────────────────────────────────────────────────────────────────────────┤
│  异常检测（Detection） · 日志解析（Parser） · 存储（Storage） · 统计（Stats） │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           数据层（本地文件存储）                             │
├─────────────────────────────────────────────────────────────────────────┤
│  数据文件（NDJSON） · 汇总文件（summary.json） · 配置文件（config.json）    │
└─────────────────────────────────────────────────────────────────────────┘
```

## 模块职责
- 用户界面层
  - 展示统计概览、最新异常列表、类型分布图表
  - 历史数据筛选与分页查看，配置参数的表单管理
- 应用服务层
  - 提供REST接口：统计、异常列表、详情、搜索、配置读取与更新
  - 提供SSE实时推送：监听数据文件增量，向前端推送新增事件
- 核心业务层
  - 按既有6类异常规则扫描日志并结构化事件
  - 将异常以NDJSON追加写入；周期生成统计汇总文件
- 数据层
  - `data/anomalies.ndjson`主数据文件（行式事件）
  - `data/anomalies/YYYY-MM-DD.ndjson`按日滚动归档
  - `data/summary.json`统计概览；`config/config.json`配置持久化

## 数据流与交互
1. 多主机Agent实时监听，命中规则后按批次调用`POST /api/ingest`上报事件
2. 中心Aggregator追加写入`anomalies.ndjson`，周期生成`summary.json`
3. 前端Dashboard读取`/api/stats`与`/api/hosts/stats`展示全局与主机概览
4. SSE服务监测文件尾部增量并推送事件（含`host_id`），页面实时更新
5. AI模块对最近事件与汇总进行分析，提供解释与建议（`/api/ai/*`）
6. 配置界面通过`GET/PUT /api/config`读取与保存`config.json`

## AI工作流（简版）
- 事件筛选：按时间窗口、类型、主机聚合最近事件
- 语义摘要：抽取关键信息（类型、影响范围、频次、上下文片段）
- 知识检索：匹配内置知识库（常见故障、内核文档摘要）
- 建议生成：规则库 + 模型生成解释与建议，标注风险
- 缓存返回：建议缓存N分钟，前端详情与Dashboard显示

## 关键流程（简版）
- 启动：初始化目录与数据文件 → 加载配置 → 启动检测引擎与Web服务 → 生成汇总 → 前端访问
- 检测：实时监听/扫描 → 命中规则 → 写入NDJSON → 更新汇总 → SSE推送前端
- 查询：前端请求历史 → 后端流式过滤NDJSON → 分页返回 → 展示与详情
- 配置：读取`config.json` → 前端修改提交 → 校验并写回 → 生效（下次周期读取）

## 页面功能设计
- Dashboard
  - 指标卡片：今日异常总数、严重异常数、检测状态
  - 列表区域：最新N条异常（时间、级别、来源、摘要），可跳详情
  - 图表区域：异常类型/级别分布（饼图/柱状图），自动/手动刷新
- History
  - 筛选区：时间范围（今日/7天/30天/自定义）、严重级别、关键词
  - 结果区：分页列表（每页20条），点击查看详情
  - 导出（可选）：CSV导出当前筛选结果
- Settings
  - 检测配置：日志路径增删、扫描间隔、保留天数
  - 告警配置（可选）：启用、邮箱、静默期
  - 显示配置：自动刷新间隔、每页条数、时间格式

## 功能验收（简版）
- P0
  - 6类异常检测正确入库（NDJSON行）
  - Dashboard统计与最新列表展示正确
  - 历史查询支持时间/级别/关键词过滤与分页
  - 配置读取/更新生效，保留策略按天清理
  - SSE实时推送，断线重连与心跳正常
  - 图表展示类型/级别分布，统计每30–60秒更新
  - 事件详情查看与基本搜索
  - AI建议：至少3类异常返回解释与建议，含风险提示
  - 邮件通知、CSV导出、趋势图